<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FR SPORT</title>
    
    <link rel="icon" href="https://img.icons8.com/color/512/football.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/512/football.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --text-main: rgba(255, 255, 255, 0.95); 
            --text-muted: rgba(255, 255, 255, 0.5);
            --accent-color: #cccccc; 
            --accent-glow: 0 0 15px rgba(204, 204, 204, 0.3);
            --accent-dark: rgba(204, 204, 204, 0.1);
            --card-bg: linear-gradient(145deg, rgba(25, 25, 30, 0.9), rgba(10, 10, 15, 0.9));
            --glass-border: rgba(204, 204, 204, 0.2);
        }

        body { 
            margin: 0; background-color: #050505; 
            background-image: linear-gradient(rgba(204, 204, 204, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(204, 204, 204, 0.03) 1px, transparent 1px);
            background-size: 30px 30px; background-attachment: fixed; color: var(--text-main); font-family: sans-serif; padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        input { -webkit-user-select: auto; user-select: auto; }
        .hidden { display: none !important; }
        .empty-msg { text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;}

        .top-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; position: sticky; top: 0; z-index: 100; background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(25px); border-bottom: 1px solid var(--glass-border); width: 100%; box-sizing: border-box; }
        .logo { font-size: 18px; font-weight: 900; letter-spacing: 2px; color: var(--accent-color); text-transform: uppercase; text-shadow: var(--accent-glow); font-style: italic; margin:0;}
        .header-actions { display: flex; align-items: center; gap: 10px; flex-direction: row; }
        .calendar-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; color: var(--accent-color); border-radius: 8px; background: var(--accent-dark); border: 1px solid var(--glass-border); }
        .live-btn { display: flex; align-items: center; gap: 6px; background: var(--accent-dark); border: 1px solid var(--glass-border); padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; color: #fff; flex-shrink: 0; cursor: pointer; outline: none;}
        .live-btn.active { background: var(--accent-color); color: #000; box-shadow: var(--accent-glow); }
        .live-dot { width: 6px; height: 6px; background: #ff3b30; border-radius: 50%; box-shadow: 0 0 5px #ff3b30; }
        .live-btn.active .live-dot { background: #000; box-shadow: none; }

        .search-container { padding: 10px 15px; width: 100%; box-sizing: border-box; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: #fff; box-sizing: border-box; outline: none; transition: 0.3s; text-align: right;}

        .dates-wrapper { width: 100%; overflow: hidden; background: #050505; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .dates-slider { display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; overflow-x: auto !important; padding: 12px 15px; gap: 10px; scrollbar-width: none; align-items: center; direction: rtl; -webkit-overflow-scrolling: touch; }
        .dates-slider::-webkit-scrollbar { display: none; }
        .date-item { font-size: 12px; color: var(--text-muted); white-space: nowrap !important; font-weight: bold; padding: 8px 18px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05); flex-shrink: 0 !important; cursor: pointer; }
        .date-item.active { color: #000; background: var(--accent-color); border-color: var(--accent-color); box-shadow: var(--accent-glow); transform: scale(1.05);}

        .league-header { display: flex; align-items: center; padding: 8px 0; margin-bottom: 10px; background: linear-gradient(270deg, var(--accent-dark) 0%, transparent 80%); border-right: 3px solid var(--accent-color); padding-right: 12px; }
        .league-title-wrapper { display: flex; align-items: center; gap: 8px; }
        .league-logo { width: 20px; height: 20px; border-radius: 50%; background: #fff; padding: 2px; }
        .league-name { font-size: 12px; font-weight: bold; color: #fff; }

        .match-row { display: flex; justify-content: center; align-items: center; padding: 12px 10px; margin-bottom: 10px; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 15px; position: relative; width: 100%; box-sizing: border-box; cursor: pointer;}
        .teams-and-score { display: flex; align-items: center; flex: 1; justify-content: center; padding: 0 10px; width: 100%; }
        .team-side { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
        .team-home { justify-content: flex-end; } .team-away { justify-content: flex-start; }
        .team-logo { width: 22px; height: 22px; flex-shrink: 0; }
        .team-name { font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .match-score { width: 75px !important; min-width: 75px !important; max-width: 75px !important; height: 28px !important; display: flex; justify-content: center; align-items: center; border-radius: 8px; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--glass-border); font-family: monospace; font-size: 14px; font-weight: bold; margin: 0 10px; flex-shrink: 0 !important; white-space: nowrap; box-sizing: border-box; }
        .score-live { background: rgba(204, 204, 204, 0.15) !important; color: #fff !important; border: 1px solid var(--accent-color) !important; box-shadow: 0 0 10px rgba(204, 204, 204, 0.2); }
        .match-status-right { position: absolute; right: 10px; display: flex; justify-content: center; align-items: center; }
        .status-plain { font-size: 10px; color: var(--text-muted); font-weight: bold; }
        .status-live-circle { width: 22px; height: 22px; border-radius: 50%; background: var(--accent-color); color: #000; display: flex; justify-content: center; align-items: center; font-size: 9px; font-weight: bold; animation: heartbeat 1.5s infinite; }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 10px 0 15px; border-top: 1px solid var(--glass-border); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-muted); font-size: 10px; font-weight: bold; cursor: pointer;}
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }
        .nav-item.active { color: var(--accent-color); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { width: 85%; max-width: 320px; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 20px; position: relative; overflow: hidden; padding: 15px;}
        .close-btn { position: absolute; top: 12px; right: 18px; font-size: 24px; color: #fff; z-index: 10; cursor: pointer; }

        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; z-index: 2000; overflow-y: auto; display: flex; flex-direction: column; }
        .full-modal-header { display: flex; align-items: center; padding: 15px; background: rgba(10, 10, 15, 0.9); border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 10; }
        .back-btn { color: var(--accent-color); font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .match-modal-title { flex: 1; text-align: center; font-size: 14px; font-weight: bold; margin-right: -40px; color:#fff;}
        .full-modal-body { padding: 15px; }

        .loader-container { display: flex; justify-content: center; padding: 40px; }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(204, 204, 204, 0.1); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .league-group { margin: 15px 10px; }
        #tab-matches.live-mode .no-live-match, #tab-matches.live-mode .not-live-match { display: none !important; }
        #no-live-msg { display: none; text-align: center; color: var(--accent-color); padding: 30px; font-weight: bold; font-size: 14px;}
        #tab-matches.live-mode:not(:has(.is-live-match)) #no-live-msg { display: block; }
        .hidden-by-search { display: none !important; }

        /* الملعب والتشكيلة والأحداث */
        .match-hero { background: linear-gradient(180deg, rgba(204,204,204,0.05), transparent); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px 15px; display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        .hero-team-name { font-size: 11px; font-weight: bold; color: #fff; margin-top: 5px; text-align: center;}
        .timeline-container { position: relative; padding: 10px 0; direction: ltr; }
        .timeline-container::before { content: ''; position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: rgba(204, 204, 204, 0.2); transform: translateX(-50%); }
        .event-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; width: 100%; }
        .event-side { width: 50%; display: flex; align-items: center; gap: 8px; }
        .event-home { justify-content: flex-end; padding-right: 25px; }
        .event-away { justify-content: flex-start; padding-left: 25px; }
        .event-time { position: absolute; left: 50%; transform: translateX(-50%); background: #050505; color: var(--accent-color); font-size: 10px; font-weight: bold; border: 1px solid var(--accent-color); border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; z-index: 2; box-shadow: var(--accent-glow); }
        .event-player { display: flex; flex-direction: column; max-width: 120px; }
        .event-home .event-player { text-align: right; align-items: flex-end; }
        .event-away .event-player { text-align: left; align-items: flex-start; }
        .event-pname { font-size: 11px; font-weight: bold; color: #fff; }
        .event-avatar { width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); object-fit: cover;}

        .pitch-container { width: 100%; aspect-ratio: 2/3; background: linear-gradient(180deg, #2e7d32 0%, #388e3c 50%, #2e7d32 100%); border: 3px solid rgba(255,255,255,0.6); position: relative; margin: 25px 0; overflow: hidden; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        .pitch-container::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.5); transform: translateY(-50%); }
        .pitch-container::after { content: ''; position: absolute; top: 50%; left: 50%; width: 22%; padding-bottom: 22%; border: 3px solid rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        .penalty-box-top { position: absolute; top: 0; left: 22%; width: 56%; height: 16%; border: 3px solid rgba(255,255,255,0.5); border-top: none; }
        .penalty-box-bottom { position: absolute; bottom: 0; left: 22%; width: 56%; height: 16%; border: 3px solid rgba(255,255,255,0.5); border-bottom: none; }
        .team-half { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; padding: 10px 0; position: relative; z-index: 5;}
        .home-half { flex-direction: column-reverse; }
        .pitch-row { display: flex; justify-content: space-evenly; align-items: center; width: 100%; }
        .pitch-player-box { display: flex; flex-direction: column; align-items: center; position: relative; width: 20%; }

        .pitch-player-img { 
            width: 36px !important; 
            height: 36px !important; 
            min-width: 36px !important;
            max-width: 36px !important;
            border-radius: 50% !important; 
            border: 2px solid #fff !important; 
            background-color: #ddd !important; 
            object-fit: cover !important; 
            object-position: top center !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5) !important; 
            display: block !important; 
            overflow: hidden !important;
        }
        img { max-width: 100%; height: auto; }

        .player-num-pitch { position: absolute; top: -5px; right: 0px; background: #cccccc; color: #000; font-weight: 900; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid #000; z-index: 3;}
        .player-name-pitch { background: rgba(0,0,0,0.75); color: #fff; font-size: 9px; font-weight: bold; padding: 3px 6px; border-radius: 10px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px; text-align: center; }

        .lineups-container { margin-top: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(204,204,204,0.2); border-radius: 15px; padding: 15px; }
        .lineups-header { text-align: center; color: #cccccc; font-weight: 900; margin-bottom: 12px; font-size: 17px; text-shadow: 0 0 15px rgba(204,204,204,0.3);}
        .lineups-formations { display: flex; justify-content: center; gap: 15px; font-size: 13px; color: #fff; margin-bottom: 15px; padding: 5px; font-weight:bold; background: rgba(0,0,0,0.2); border-radius: 20px; width: fit-content; margin-left: auto; margin-right: auto;}
        .formation-badge { background: #cccccc; color: #000; padding: 2px 8px; border-radius: 8px; }
        .lineup-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px 0; }
        .lineup-player { display: flex; align-items: center; gap: 10px; width: 48%; font-size: 12px; color: #fff; overflow: hidden; }
        .home-player { justify-content: flex-start; } .away-player { justify-content: flex-end; flex-direction: row-reverse; text-align: right; }
        .player-num { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: #cccccc; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; border-radius: 50%; font-size: 11px; font-weight: bold; flex-shrink: 0;}
        .player-name { text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="header-actions">
            <div class="calendar-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            </div>
            <button class="live-btn" onclick="toggleLive(this)">
                <span class="live-dot"></span> مباشر
            </button>
        </div>
        <div class="logo">FR SPORT</div>
    </header>

    <div class="dates-wrapper">
        <div id="dates-container" class="dates-slider"></div>
    </div>

    <div class="search-container">
        <input type="text" id="match-search" class="search-input" placeholder="ابحث عن مباراة أو فريق..." onkeyup="filterMatches()">
    </div>

    <main class="app-content">
        <div id="tab-matches" class="page-content">
            <div class="loader-container"><div class="spinner"></div></div>
        </div>
        <div id="tab-news" class="page-content hidden"><p class="empty-msg">قريباً - قسم الأخبار</p></div>
        <div id="tab-leagues" class="page-content hidden"><p class="empty-msg">قريباً - قسم البطولات</p></div>
    </main>

    <div id="match-modal" class="full-modal hidden">
        <div class="full-modal-header">
            <div class="back-btn" onclick="closeModal('match-modal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> رجوع
            </div>
            <div class="match-modal-title">تفاصيل المباراة</div>
        </div>
        <div class="full-modal-body" id="match-info-container"></div>
    </div>

    <div id="team-modal" class="modal hidden">
        <div class="close-btn" onclick="closeModal('team-modal')">&times;</div>
        <div class="modal-content" id="team-info-container"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab(this, 'tab-matches')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            <span>المباريات</span>
        </div>
        <div class="nav-item" onclick="switchTab(this, 'tab-news')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            <span>الأخبار</span>
        </div>
        <div class="nav-item" onclick="switchTab(this, 'tab-leagues')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path></svg>
            <span>البطولات</span>
        </div>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEGxx2tlEsw09VJPWyL1Dd_-n6mziatuA",
            authDomain: "fr-sport.firebaseapp.com",
            projectId: "fr-sport",
            storageBucket: "fr-sport.firebasestorage.app",
            messagingSenderId: "247900578680",
            appId: "1:247900578680:web:03c1af6d0351737a19de8d",
            measurementId: "G-W1K6K94HDL"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        const SERVER_URL = "https://spring-dream-011d.farhad10180.workers.dev";
        const TOP_LEAGUES = [2, 3, 39, 140, 135, 78, 61, 307, 1, 4, 17, 12];
        let globalMatches = []; 

        const svgIcons = {
            subIn: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00e676" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`,
            subOut: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>`,
            goal: `<svg width="14" height="14" viewBox="0 0 24 24" fill="#fff" stroke="#000" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3" fill="#000"></circle><path d="M12 2l0 7M12 22l0-7M2 12l7 0M22 12l-7 0"></path></svg>`,
            yellowCard: `<svg width="12" height="16" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="3" fill="#ffeb3b" stroke="#fbc02d" stroke-width="1"/></svg>`,
            redCard: `<svg width="12" height="16" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="3" fill="#f44336" stroke="#d32f2f" stroke-width="1"/></svg>`,
            stadium: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>`
        };

        function setupDatesBar() {
            const container = document.getElementById('dates-container');
            if (!container) return;
            container.innerHTML = '';
            const today = new Date();
            const daysNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            for (let i = -10; i <= 10; i++) {
                let d = new Date(); d.setDate(today.getDate() + i); let dateStr = d.toISOString().split('T')[0];
                let label = i === 0 ? "اليوم" : i === -1 ? "أمس" : i === 1 ? "غداً" : `${daysNames[d.getDay()]} ${d.getDate()}`;
                let activeClass = i === 0 ? "active" : "";
                container.innerHTML += `<div class="date-item ${activeClass}" id="btn-${dateStr}" onclick="selectDate('${dateStr}')">${label}</div>`;
            }
            setTimeout(() => { document.querySelector('.date-item.active')?.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
        }

        function selectDate(dateStr) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById('tab-matches').classList.remove('hidden');
            document.querySelectorAll('.bottom-nav .nav-item')[0].classList.add('active'); 
            document.querySelectorAll('.date-item').forEach(item => item.classList.remove('active'));
            const clickedBtn = document.getElementById(`btn-${dateStr}`);
            if (clickedBtn) { clickedBtn.classList.add('active'); clickedBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }
            fetchFotMobStyle(dateStr);
        }

        function switchTab(element, tabId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
            if(document.getElementById(tabId)) document.getElementById(tabId).classList.remove('hidden'); 
            element.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleLive(element) {
            element.classList.toggle('active');
            const container = document.getElementById('tab-matches');
            if (element.classList.contains('active')) { container.classList.add('live-mode'); } 
            else { container.classList.remove('live-mode'); }
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function fetchFotMobStyle(selectedDate = null) {
            const targetDate = selectedDate || new Date().toISOString().split('T')[0];
            const container = document.getElementById('tab-matches');
            const liveBtn = document.querySelector('.live-btn');
            if (liveBtn) liveBtn.classList.remove('active');
            container.classList.remove('live-mode');
            
            container.innerHTML = '<div class="loader-container"><div class="spinner"></div></div>';
            
            const cacheKey = `matches_${targetDate}`;
            const cachedData = sessionStorage.getItem(cacheKey);
            
            if (cachedData) {
                globalMatches = JSON.parse(cachedData);
                renderMatchesUI();
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/fixtures?date=${targetDate}`);
                const data = await response.json();
                if (data.errors && data.errors.requests) { 
                    if(!cachedData) container.innerHTML = `<div class="empty-msg">انتهت الباقة اليومية.</div>`; 
                    return; 
                }
                globalMatches = data.response || []; 
                sessionStorage.setItem(cacheKey, JSON.stringify(globalMatches));
                renderMatchesUI(); 
            } catch (error) { 
                if(!cachedData) container.innerHTML = "<p class='empty-msg'>حدث خطأ بالاتصال بالسيرفر، تأكد من الإنترنت.</p>"; 
            }
        }

        function isLiveMatch(status) { return ['1H', '2H', 'HT', 'ET', 'P', 'LIVE'].includes(status); }

        function renderMatchesUI() {
            const container = document.getElementById('tab-matches');
            if (!globalMatches || globalMatches.length === 0) { container.innerHTML = "<p class='empty-msg'>لا توجد مباريات في هذا التاريخ</p>"; return; }

            const leaguesGroup = {};
            globalMatches.forEach(m => {
                if (!leaguesGroup[m.league.name]) leaguesGroup[m.league.name] = { info: m.league, games: [], hasLive: false };
                leaguesGroup[m.league.name].games.push(m);
                if (isLiveMatch(m.fixture.status.short)) leaguesGroup[m.league.name].hasLive = true;
            });

            const sortedLeagues = Object.values(leaguesGroup).sort((a, b) => {
                if (a.hasLive && !b.hasLive) return -1;
                if (!a.hasLive && b.hasLive) return 1;
                const aTop = TOP_LEAGUES.includes(a.info.id) ? TOP_LEAGUES.indexOf(a.info.id) : 999;
                const bTop = TOP_LEAGUES.includes(b.info.id) ? TOP_LEAGUES.indexOf(b.info.id) : 999;
                return aTop - bTop;
            });

            container.innerHTML = `<div id="no-live-msg">لا توجد مباريات مباشرة حالياً</div>`; 

            sortedLeagues.forEach(group => {
                const league = group.info;
                group.games.sort((a, b) => {
                    const aLive = isLiveMatch(a.fixture.status.short) ? -1 : 1;
                    const bLive = isLiveMatch(b.fixture.status.short) ? -1 : 1;
                    if (aLive !== bLive) return aLive - bLive; 
                    return new Date(a.fixture.date) - new Date(b.fixture.date); 
                });

                let leagueClass = group.hasLive ? 'has-live-match' : 'no-live-match';
                let leagueHTML = `<div class="league-group ${leagueClass}"><div class="league-header"><div class="league-title-wrapper"><img src="${league.logo}" class="league-logo"><span class="league-name">${league.name}</span></div></div>`;

                group.games.forEach(m => {
                    const s = m.fixture.status.short;
                    const isLive = isLiveMatch(s);
                    const isNotStarted = ['NS', 'TBD'].includes(s);
                    let matchClass = isLive ? 'is-live-match' : 'not-live-match';
                    let centerText = ''; let rightStatus = '';
                    
                    if (isNotStarted) {
                        const timeStr = new Date(m.fixture.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                        centerText = `<div class="match-score" dir="ltr">${timeStr}</div>`; rightStatus = `<span class="status-plain">-</span>`; 
                    } else if (isLive) {
                        centerText = `<div class="match-score score-live" dir="ltr">${m.goals.home} - ${m.goals.away}</div>`; rightStatus = `<div class="status-live-circle">${m.fixture.status.elapsed}'</div>`; 
                    } else {
                        centerText = `<div class="match-score" dir="ltr">${m.goals.home ?? '-'} - ${m.goals.away ?? '-'}</div>`; rightStatus = `<span class="status-plain">${['FT', 'AET', 'PEN'].includes(s) ? 'FT' : s}</span>`; 
                    }

                    leagueHTML += `
                        <div class="match-row ${matchClass}" onclick="openMatchDetails(${m.fixture.id})">
                            <div class="teams-and-score">
                                <div class="team-side team-home" onclick="showTeamInfo(event, ${m.teams.home.id})"><span class="team-name">${m.teams.home.name}</span><img src="${m.teams.home.logo}" class="team-logo"></div>
                                <div>${centerText}</div>
                                <div class="team-side team-away" onclick="showTeamInfo(event, ${m.teams.away.id})"><img src="${m.teams.away.logo}" class="team-logo"><span class="team-name">${m.teams.away.name}</span></div>
                            </div>
                            <div class="match-status-right" dir="ltr">${rightStatus}</div>
                        </div>`;
                });
                leagueHTML += `</div>`; container.innerHTML += leagueHTML;
            });
        }

        function filterMatches() {
            const query = document.getElementById('match-search').value.toLowerCase();
            document.querySelectorAll('.match-row').forEach(row => { row.classList.toggle('hidden-by-search', !row.innerText.toLowerCase().includes(query)); });
            document.querySelectorAll('.league-group').forEach(group => {
                const hasVisible = Array.from(group.querySelectorAll('.match-row')).some(m => !m.classList.contains('hidden-by-search'));
                group.classList.toggle('hidden-by-search', !hasVisible);
            });
        }

        async function showTeamInfo(event, teamId) {
            if(event) event.stopPropagation(); 
            const modal = document.getElementById('team-modal'); 
            const container = document.getElementById('team-info-container');
            modal.classList.remove('hidden'); 
            
            container.innerHTML = '<div class="loader-container"><div class="spinner"></div></div><div style="text-align:center; color:gray; font-size:12px; margin-top:-20px;">جاري جلب بيانات النادي واللاعبين...</div>';
            
            try {
                const teamRes = await fetch(`${SERVER_URL}/teams?id=${teamId}`);
                const teamData = await teamRes.json();
                const squadRes = await fetch(`${SERVER_URL}/players/squads?team=${teamId}`);
                const squadData = await squadRes.json();

                if (teamData.response && teamData.response.length > 0) {
                    const team = teamData.response[0].team;
                    const venue = teamData.response[0].venue;
                    
                    let html = `
                        <div style="text-align:center; margin-bottom:15px;">
                            <img src="${team.logo}" width="80" style="filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); max-width:100%;">
                            <h2 style="color:#fff; margin:10px 0 0 0;">${team.name}</h2>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;"><span style="font-size:10px; color:gray;">البلد</span><br><strong style="color:#ccc;">${team.country || '-'}</strong></div>
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px;"><span style="font-size:10px; color:gray;">التأسيس</span><br><strong style="color:#ccc;">${team.founded || '-'}</strong></div>
                        </div>
                        <div style="margin-top:15px; background:rgba(30,30,35,0.6); padding:15px; border-radius:10px; display:flex; align-items:center; gap:10px; border: 1px solid rgba(255,255,255,0.05);">
                            ${svgIcons.stadium}
                            <div>
                                <div style="color:#fff; font-size:12px; font-weight:bold;">${venue.name || 'ملعب غير معروف'}</div>
                                <div style="color:gray; font-size:10px;">المدينة: ${venue.city || '-'} | السعة: ${venue.capacity ? venue.capacity.toLocaleString() : '-'}</div>
                            </div>
                        </div>`;

                    if (squadData.response && squadData.response.length > 0) {
                        const players = squadData.response[0].players;
                        if (players && players.length > 0) {
                            html += `
                                <div style="margin-top:20px;">
                                    <h3 style="color:#cccccc; font-size:14px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; margin-bottom:15px;">قائمة لاعبي الفريق</h3>
                                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(70px, 1fr)); gap:10px; max-height: 350px; overflow-y: auto; padding-right:5px; scrollbar-width: none;">`;
                            
                            players.forEach(p => {
                                let fallbackImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";
                                html += `
                                    <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:10px; padding:10px 5px; text-align:center; position:relative;">
                                        <div style="position:absolute; top:4px; left:4px; background:#cccccc; color:#000; font-size:9px; font-weight:900; width:16px; height:16px; display:flex; justify-content:center; align-items:center; border-radius:50%; border:1px solid #000;">${p.number || '-'}</div>
                                        <img src="${p.photo}" onerror="this.src='${fallbackImg}'" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.1); margin-bottom:6px; background:#eee; max-width:100%;">
                                        <div style="font-size:9px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:bold;" dir="ltr">${p.name}</div>
                                        <div style="font-size:8px; color:#999; margin-top:3px;">${p.position || '-'}</div>
                                    </div>`;
                            });
                            html += `</div></div>`;
                        }
                    } else {
                        html += `<div style="margin-top:20px; text-align:center; color:gray; font-size:12px;">قائمة اللاعبين غير متوفرة حالياً</div>`;
                    }

                    container.innerHTML = html;
                }
            } catch (e) { 
                container.innerHTML = '<p class="empty-msg" style="color:#ff3b30;">حدث خطأ في جلب بيانات النادي</p>'; 
            }
        }

        function buildPitchHTML(lineup, isHome) {
            if (!lineup || !lineup.startXI) return '';
            let lines = { GK: [], DEF: [], MID: [], FWD: [] };
            lineup.startXI.forEach(item => {
                let pos = item.player.pos;
                if (pos === 'G') lines.GK.push(item);
                else if (pos === 'D') lines.DEF.push(item);
                else if (pos === 'M') lines.MID.push(item);
                else if (pos === 'F') lines.FWD.push(item);
            });
            const sortPlayers = (arr) => arr.sort((a,b) => {
                let cA = a.player.grid ? Number(a.player.grid.split(':')[1]) : 0;
                let cB = b.player.grid ? Number(b.player.grid.split(':')[1]) : 0;
                return cA - cB;
            });
            let html = '';
            const buildRow = (players) => {
                sortPlayers(players);
                let rowHTML = '<div class="pitch-row">';
                players.forEach(item => {
                    let p = item.player;
                    let imgUrl = `https://media.api-sports.io/football/players/${p.id}.png`;
                    let fallbackImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23999'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";
                    let shortName = p.name.split(' ').pop();
                    rowHTML += `
                        <div class="pitch-player-box">
                            <div style="position:relative;">
                                <img src="${imgUrl}" class="pitch-player-img" onerror="this.src='${fallbackImg}'">
                                <div class="player-num-pitch">${p.number || '-'}</div>
                            </div>
                            <div class="player-name-pitch" dir="ltr">${shortName}</div>
                        </div>`;
                });
                rowHTML += '</div>';
                return rowHTML;
            }
            if (isHome) { html += buildRow(lines.GK); html += buildRow(lines.DEF); html += buildRow(lines.MID); html += buildRow(lines.FWD); } 
            else { html += buildRow(lines.FWD); html += buildRow(lines.MID); html += buildRow(lines.DEF); html += buildRow(lines.GK); }
            return html;
        }

        async function openMatchDetails(fixtureId) {
            const modal = document.getElementById('match-modal'); 
            const container = document.getElementById('match-info-container');
            modal.classList.remove('hidden'); 
            container.innerHTML = '<div class="loader-container"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${SERVER_URL}/fixtures?id=${fixtureId}`);
                const data = await response.json(); 
                const m = data.response[0];
                if(!m) return;

                let eventsHTML = '<div class="timeline-container">';
                if(m.events && m.events.length > 0) {
                    m.events.forEach(ev => {
                        const isHome = ev.team.id === m.teams.home.id;
                        const playerImg = `https://media.api-sports.io/football/players/${ev.player.id}.png`;
                        let eventBody = `<span class="event-pname">${ev.player.name}</span>`;
                        let icon = '';

                        if (ev.type === 'Goal') { 
                            icon = svgIcons.goal; 
                            if(ev.assist.name) eventBody += `<div style="font-size:9px; color:gray; margin-top:2px;">${ev.assist.name}</div>`; 
                        } 
                        else if (ev.type === 'Card') { 
                            icon = ev.detail.includes('Yellow') ? svgIcons.yellowCard : svgIcons.redCard; 
                        } 
                        else if (ev.type === 'subst') {
                            eventBody = `<div style="display:flex; flex-direction:column; gap:2px;"><div style="display:flex; align-items:center; gap:4px; font-weight:bold;">${svgIcons.subIn} ${ev.player.name}</div><div style="font-size:10px; color:gray; display:flex; align-items:center; gap:4px;">${svgIcons.subOut} ${ev.assist.name}</div></div>`;
                        }

                        eventsHTML += `
                            <div class="event-row">
                                <div class="event-side event-home">${isHome ? `<div class="event-player">${eventBody}</div><img src="${playerImg}" class="event-avatar" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'%23999\\'%3E%3Cpath d=\\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\\'/%3E%3C/svg%3E'"> ${icon}` : ''}</div>
                                <div class="event-time">'${ev.time.elapsed}</div>
                                <div class="event-side event-away">${!isHome ? `${icon} <img src="${playerImg}" class="event-avatar" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'%23999\\'%3E%3Cpath d=\\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\\'/%3E%3C/svg%3E'"><div class="event-player">${eventBody}</div>` : ''}</div>
                            </div>`;
                    });
                } else { eventsHTML += '<p class="empty-msg">لا توجد أحداث مسجلة بعد.</p>'; }
                eventsHTML += '</div>';

                let pitchAreaHTML = ''; let subsHTML = '';
                if (m.lineups && m.lineups.length > 0) {
                    const hLineup = m.lineups[0]; const aLineup = m.lineups.length > 1 ? m.lineups[1] : null;
                    pitchAreaHTML = `
                    <div class="lineups-header" style="margin-top:25px;">التشكيلة الأساسية</div>
                    <div class="lineups-formations">
                        <span class="formation-badge" dir="ltr">${hLineup.formation || '-'}</span>
                        <span>الخطة</span>
                        <span class="formation-badge" dir="ltr">${aLineup ? (aLineup.formation || '-') : '-'}</span>
                    </div>
                    <div class="pitch-container">
                        <div class="penalty-box-top"></div><div class="penalty-box-bottom"></div>
                        <div class="team-half away-half">${aLineup ? buildPitchHTML(aLineup, false) : ''}</div>
                        <div class="team-half home-half">${buildPitchHTML(hLineup, true)}</div>
                    </div>`;
                    
                    subsHTML = `<div class="lineups-container"><div class="lineups-header">قائمة البدلاء</div><div class="lineups-grid">`;
                    let maxSubs = Math.max(hLineup.substitutes?.length || 0, aLineup?.substitutes?.length || 0);
                    for(let i=0; i<maxSubs; i++) {
                        const hSub = hLineup.substitutes && hLineup.substitutes[i] ? hLineup.substitutes[i].player : null;
                        const aSub = (aLineup && aLineup.substitutes && aLineup.substitutes[i]) ? aLineup.substitutes[i].player : null;
                        if(!hSub && !aSub) break;
                        subsHTML += `
                            <div class="lineup-row">
                                <div class="lineup-player home-player"><span class="player-num">${hSub?.number || '-'}</span><span class="player-name">${hSub?.name || '-'}</span></div>
                                <div class="lineup-player away-player"><span class="player-num">${aSub?.number || '-'}</span><span class="player-name">${aSub?.name || '-'}</span></div>
                            </div>`;
                    }
                    subsHTML += `</div></div>`;
                } else { pitchAreaHTML = '<p class="empty-msg">التشكيلة غير متوفرة لهذه المباراة حالياً</p>'; }

                container.innerHTML = `
                    <div class="match-hero">
                        <div style="text-align:center; cursor:pointer;" onclick="showTeamInfo(event, ${m.teams.home.id})"><img src="${m.teams.home.logo}" width="60" style="max-width:100%;"><br><span class="hero-team-name">${m.teams.home.name}</span></div>
                        <div style="text-align:center"><div style="font-size:38px; font-weight:900; color:#cccccc; text-shadow:0 0 15px rgba(204,204,204,0.3);" dir="ltr">${m.goals.home ?? '-'} - ${m.goals.away ?? '-'}</div><div style="background:#cccccc; color:#000; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">${m.fixture.status.long}</div></div>
                        <div style="text-align:center; cursor:pointer;" onclick="showTeamInfo(event, ${m.teams.away.id})"><img src="${m.teams.away.logo}" width="60" style="max-width:100%;"><br><span class="hero-team-name">${m.teams.away.name}</span></div>
                    </div>
                    ${eventsHTML} ${pitchAreaHTML} ${subsHTML}
                `;
            } catch (e) { container.innerHTML = '<p class="empty-msg">خطأ في جلب تفاصيل المباراة</p>'; }
        }

        setupDatesBar(); 
        fetchFotMobStyle();
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) { registration.unregister(); }
        });
      }
    </script>
</body>
</html>
