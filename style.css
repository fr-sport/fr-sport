// === المفاتيح السحرية لـ Firebase ===
const firebaseConfig = {
    apiKey: "AIzaSyCEGxx2tlEsw09VJPWyL1Dd_-n6mziatuA",
    authDomain: "fr-sport.firebaseapp.com",
    projectId: "fr-sport",
    storageBucket: "fr-sport.firebasestorage.app",
    messagingSenderId: "247900578680",
    appId: "1:247900578680:web:03c1af6d0351737a19de8d",
    measurementId: "G-W1K6K94HDL"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
console.log("تم الاتصال بقاعدة البيانات بنجاح");

// === سيرفر جلب المباريات ===
const SERVER_URL = "https://spring-dream-011d.farhad10180.workers.dev";
const TOP_LEAGUES = [2, 3, 39, 140, 135, 78, 61, 307, 1, 4, 17, 12];
let globalMatches = []; 

function setupDatesBar() {
    const container = document.getElementById('dates-container');
    if (!container) return;
    container.innerHTML = '';
    const today = new Date();
    const daysNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    for (let i = -10; i <= 10; i++) {
        let d = new Date(); d.setDate(today.getDate() + i); let dateStr = d.toISOString().split('T')[0];
        let label = i === 0 ? "اليوم" : i === -1 ? "أمس" : i === 1 ? "غداً" : `${daysNames[d.getDay()]} ${d.getDate()}`;
        let activeClass = i === 0 ? "active" : "";
        container.innerHTML += `<div class="date-item ${activeClass}" id="btn-${dateStr}" onclick="selectDate('${dateStr}')">${label}</div>`;
    }
    setTimeout(() => { document.querySelector('.date-item.active')?.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
}

function selectDate(dateStr) {
    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
    document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
    document.getElementById('tab-matches').classList.remove('hidden');
    document.querySelectorAll('.bottom-nav .nav-item')[0].classList.add('active'); 
    document.querySelectorAll('.date-item').forEach(item => item.classList.remove('active'));
    const clickedBtn = document.getElementById(`btn-${dateStr}`);
    if (clickedBtn) { clickedBtn.classList.add('active'); clickedBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }
    fetchFotMobStyle(dateStr);
}

function switchTab(element, tabId) {
    document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
    document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
    if(document.getElementById(tabId)) document.getElementById(tabId).classList.remove('hidden'); 
    element.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toggleLive(element) {
    element.classList.toggle('active');
    const container = document.getElementById('tab-matches');
    if (element.classList.contains('active')) {
        container.classList.add('live-mode');
    } else {
        container.classList.remove('live-mode');
    }
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

async function fetchFotMobStyle(selectedDate = null) {
    const targetDate = selectedDate || new Date().toISOString().split('T')[0];
    const container = document.getElementById('tab-matches');
    const liveBtn = document.querySelector('.live-btn');
    if (liveBtn) liveBtn.classList.remove('active');
    container.classList.remove('live-mode');
    container.innerHTML = '<div class="loader-container"><div class="spinner"></div></div>';
    
    try {
        const response = await fetch(`${SERVER_URL}/fixtures?date=${targetDate}`);
        const data = await response.json();
        if (data.errors && data.errors.requests) { container.innerHTML = `<div class="empty-msg">انتهت الباقة.</div>`; return; }
        globalMatches = data.response || []; 
        renderMatchesUI(); 
    } catch (error) { 
        container.innerHTML = "<p class='empty-msg'>حدث خطأ بالاتصال بالسيرفر</p>"; 
    }
}

function isLiveMatch(status) { return ['1H', '2H', 'HT', 'ET', 'P', 'LIVE'].includes(status); }

function renderMatchesUI() {
    const container = document.getElementById('tab-matches');
    if (!globalMatches || globalMatches.length === 0) { container.innerHTML = "<p class='empty-msg'>لا توجد مباريات في هذا التاريخ</p>"; return; }

    const leaguesGroup = {};
    globalMatches.forEach(m => {
        if (!leaguesGroup[m.league.name]) leaguesGroup[m.league.name] = { info: m.league, games: [], hasLive: false };
        leaguesGroup[m.league.name].games.push(m);
        if (isLiveMatch(m.fixture.status.short)) leaguesGroup[m.league.name].hasLive = true;
    });

    const sortedLeagues = Object.values(leaguesGroup).sort((a, b) => {
        if (a.hasLive && !b.hasLive) return -1;
        if (!a.hasLive && b.hasLive) return 1;
        const aTop = TOP_LEAGUES.includes(a.info.id) ? TOP_LEAGUES.indexOf(a.info.id) : 999;
        const bTop = TOP_LEAGUES.includes(b.info.id) ? TOP_LEAGUES.indexOf(b.info.id) : 999;
        return aTop - bTop;
    });

    container.innerHTML = `<div id="no-live-msg">لا توجد مباريات مباشرة حالياً</div>`; 

    sortedLeagues.forEach(group => {
        const league = group.info;
        group.games.sort((a, b) => {
            const aLive = isLiveMatch(a.fixture.status.short) ? -1 : 1;
            const bLive = isLiveMatch(b.fixture.status.short) ? -1 : 1;
            if (aLive !== bLive) return aLive - bLive; 
            return new Date(a.fixture.date) - new Date(b.fixture.date); 
        });

        let leagueClass = group.hasLive ? 'has-live-match' : 'no-live-match';
        let leagueHTML = `<div class="league-group ${leagueClass}"><div class="league-header"><div class="league-title-wrapper"><img src="${league.logo}" class="league-logo"><span class="league-name">${league.name}</span></div></div>`;

        group.games.forEach(m => {
            const s = m.fixture.status.short;
            const isLive = isLiveMatch(s);
            const isNotStarted = ['NS', 'TBD'].includes(s);
            let matchClass = isLive ? 'is-live-match' : 'not-live-match';
            let centerText = ''; let rightStatus = '';
            
            if (isNotStarted) {
                const timeStr = new Date(m.fixture.date).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                centerText = `<div class="match-score" dir="ltr">${timeStr}</div>`; rightStatus = `<span class="status-plain">-</span>`; 
            } else if (isLive) {
                centerText = `<div class="match-score score-live" dir="ltr">${m.goals.home} - ${m.goals.away}</div>`; rightStatus = `<div class="status-live-circle">${m.fixture.status.elapsed}'</div>`; 
            } else {
                centerText = `<div class="match-score" dir="ltr">${m.goals.home ?? '-'} - ${m.goals.away ?? '-'}</div>`; rightStatus = `<span class="status-plain">${['FT', 'AET', 'PEN'].includes(s) ? 'FT' : s}</span>`; 
            }

            leagueHTML += `
                <div class="match-row ${matchClass}">
                    <div class="teams-and-score">
                        <div class="team-side team-home"><span class="team-name">${m.teams.home.name}</span><img src="${m.teams.home.logo}" class="team-logo"></div>
                        <div>${centerText}</div>
                        <div class="team-side team-away"><img src="${m.teams.away.logo}" class="team-logo"><span class="team-name">${m.teams.away.name}</span></div>
                    </div>
                    <div class="match-status-right" dir="ltr">${rightStatus}</div>
                </div>`;
        });
        leagueHTML += `</div>`; container.innerHTML += leagueHTML;
    });
}

function filterMatches() {
    const query = document.getElementById('match-search').value.toLowerCase();
    document.querySelectorAll('.match-row').forEach(row => { row.classList.toggle('hidden-by-search', !row.innerText.toLowerCase().includes(query)); });
    document.querySelectorAll('.league-group').forEach(group => {
        const hasVisible = Array.from(group.querySelectorAll('.match-row')).some(m => !m.classList.contains('hidden-by-search'));
        group.classList.toggle('hidden-by-search', !hasVisible);
    });
}

setupDatesBar(); 
fetchFotMobStyle();
